<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech-to-Text Transcription</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca para codificação de MP3 -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        <main class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white">Voice-to-Text</h1>
                <p class="text-md text-gray-600 dark:text-gray-400 mt-2">Record or upload audio to get a transcription.</p>
            </header>

            <!-- Controls Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4 text-center text-gray-700 dark:text-gray-200">1. Provide Audio</h2>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <!-- Record Controls -->
                    <button id="recordBtn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>
                        Record
                    </button>
                    <button id="stopBtn" class="w-full sm:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all btn-disabled" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"></path></svg>
                        Stop
                    </button>
                    <span class="text-gray-500 dark:text-gray-400">OR</span>
                    <!-- Upload Control -->
                    <label for="audioUpload" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Upload File
                    </label>
                    <input type="file" id="audioUpload" class="hidden" accept="audio/*">
                </div>
            </div>

            <!-- Audio Player & Transcribe Button -->
            <div id="audioPlayerContainer" class="mt-6 text-center hidden">
                <audio id="audioPlayer" controls class="w-full"></audio>
                <button id="transcribeBtn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Transcribe Audio
                </button>
            </div>

            <!-- Transcription Output -->
            <div class="mt-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">2. Transcription</h2>
                <div id="transcriptionContainer" class="w-full min-h-[150px] p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 relative">
                    <div id="loader" class="absolute inset-0 flex items-center justify-center bg-gray-50 dark:bg-gray-700 bg-opacity-75 hidden">
                        <div class="loader"></div>
                    </div>
                    <div id="copyBtnContainer" class="absolute top-2 right-2 hidden">
                        <button id="copyBtn" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 p-2 rounded-md" title="Copy to clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                    <p id="transcriptionText" class="text-gray-500 dark:text-gray-400">Your transcription will appear here...</p>
                </div>
            </div>
        </main>
        <div id="toast" class="toast"></div>
    </div>

    <script>
        // UI Elements
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const audioUpload = document.getElementById('audioUpload');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');
        const audioPlayer = document.getElementById('audioPlayer');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const loader = document.getElementById('loader');
        const transcriptionText = document.getElementById('transcriptionText');
        const copyBtnContainer = document.getElementById('copyBtnContainer');
        const copyBtn = document.getElementById('copyBtn');
        const toast = document.getElementById('toast');

        // MediaRecorder variables
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let audioFilename = 'recording.mp3';

        // --- Recording Logic ---
        recordBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    showToast('Encoding to MP3, please wait...');
                    // Convert the recorded WAV audio to MP3
                    const wavBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    audioChunks = [];

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        audioContext.decodeAudioData(event.target.result, (buffer) => {
                            const mp3Encoder = new lamejs.Mp3Encoder(buffer.numberOfChannels, buffer.sampleRate, 128); // 128kbps
                            const pcmData = buffer.getChannelData(0);
                            const samples = new Int16Array(pcmData.length);
                            for (let i = 0; i < pcmData.length; i++) {
                                samples[i] = pcmData[i] * 32767;
                            }

                            const mp3Data = [];
                            const sampleBlockSize = 1152;
                            for (let i = 0; i < samples.length; i += sampleBlockSize) {
                                const sampleChunk = samples.subarray(i, i + sampleBlockSize);
                                const mp3buf = mp3Encoder.encodeBuffer(sampleChunk);
                                if (mp3buf.length > 0) {
                                    mp3Data.push(new Int8Array(mp3buf));
                                }
                            }
                            const endMp3 = mp3Encoder.flush();
                            if (endMp3.length > 0) {
                                mp3Data.push(new Int8Array(endMp3));
                            }

                            audioBlob = new Blob(mp3Data, { type: 'audio/mpeg' });
                            audioFilename = `recording_${new Date().getTime()}.mp3`;
                            const audioUrl = URL.createObjectURL(audioBlob);
                            
                            audioPlayer.src = audioUrl;
                            audioPlayerContainer.classList.remove('hidden');
                            showToast('MP3 encoding complete!');
                        });
                    };
                    reader.readAsArrayBuffer(wavBlob);
                };

                mediaRecorder.start();
                toggleRecordingControls(true);
            } catch (err) {
                console.error("Error accessing microphone:", err);
                showToast("Could not access microphone. Please grant permission.");
            }
        });

        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            toggleRecordingControls(false);
        });

        function toggleRecordingControls(isRecording) {
            recordBtn.disabled = isRecording;
            stopBtn.disabled = !isRecording;
            recordBtn.classList.toggle('btn-disabled', isRecording);
            stopBtn.classList.toggle('btn-disabled', !isRecording);
        }

        // --- File Upload Logic ---
        audioUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                audioBlob = file;
                audioFilename = file.name;
                const audioUrl = URL.createObjectURL(file);
                audioPlayer.src = audioUrl;
                audioPlayerContainer.classList.remove('hidden');
            }
        });

        // --- Transcription Logic ---
        transcribeBtn.addEventListener('click', async () => {
            if (!audioBlob) {
                showToast("No audio to transcribe. Please record or upload an audio file.");
                return;
            }

            loader.classList.remove('hidden');
            transcriptionText.textContent = "Uploading and transcribing, please wait...";
            copyBtnContainer.classList.add('hidden');

            const formData = new FormData();
            formData.append('audio_file', audioBlob, audioFilename);

            try {
                const response = await fetch('/transcribe', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Network response was not ok');
                }
                
                transcriptionText.textContent = result.transcription;
                copyBtnContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Error during transcription:', error);
                transcriptionText.textContent = `An error occurred: ${error.message}`;
            } finally {
                loader.classList.add('hidden');
            }
        });

        // --- Utility Functions ---
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(transcriptionText.textContent).then(() => {
                showToast("Transcription copied to clipboard!");
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showToast("Failed to copy text.");
            });
        });

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

    </script>
</body>
</html>
